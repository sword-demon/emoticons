好的，这是一个非常有价值的迭代方向。将支付功能和“以图生图”的主体识别功能加入，会让产品闭环更完整，商业模式更清晰。

这是在 **V2.0** 版本基础上进行迭代，加入了新需求的 **V3.0** 版本需求文档。

---

## **AI 表情包生成器项目需求文档 (PRD)**

| **文档版本** | **V3.0**           | **状态**   | **迭代规划**    |
| :----------- | :----------------- | :--------- | :-------------- |
| **创建日期** | 2025 年 9 月 21 日 | **创建者** | [你的名字/团队] |
| **最后更新** | 2025 年 9 月 21 日 | **更新者** | [你的名字/团队] |

### **V3.0 更新摘要**

1.  **下载与付费策略调整**: 预览图均带水印；水印版图片可免费打包下载；无水印版本需完成支付后下载（对接 z-pay）。
2.  **新增图片识别主体功能**: 允许用户上传一张图片，系统通过 AI 自动识别并生成主体文字描述。

---

### 1. 项目概述

#### 1.1 项目背景 (同 V2.0)

...

#### 1.2 项目目标 (更新)

- 降低创作门槛: 提供强大的文案引导、**图像识别**和灵感激发功能，消除用户的“创意白屏恐惧症”。
- 实现高效生成: 用户可通过**文字描述或上传图片**定义核心概念，一键生成一套（16 张）风格统一的表情包。
- 自动化专业输出: 自动完成文字叠加、多尺寸处理，并打包成符合微信表情包平台上传规范的 ZIP 文件。
- **探索商业模式**: 通过付费下载功能，验证产品的商业价值。
- 提供无缝体验: 实现“预览-付费-下载即可上传”的完整商业闭环。

#### 1.3 技术栈 (更新)

- **前端**: Next.js, CSS, Axios, Canvas API (or `fabric.js`), `browser-image-compression`, `jszip`
- **后端**: Node.js (Next.js API Routes)
- **AI 服务**:
  - **文生图**: 即梦 AI (官方 Node.js SDK)
  - **图生文 (新增)**: 第三方图像识别/描述生成 API (如 [火山引擎图文描述](https://www.volcengine.com/docs/6287/65809)、Google Cloud Vision AI 或类似服务)
- **支付服务 (新增)**: z-pay 聚合支付（参考文档: https://z-pay.cn/doc.html）

---

### 2. 核心功能需求

#### 2.1 表情包生成界面 (UI/UX) (更新)

##### 2.1.1 输入区域

- **表情包主体描述 (Subject)**

  - **UI 组件**:
    1.  **新增 "上传图片识别主体" 按钮**: 位于文本输入框上方或旁边。
    2.  单行文本输入框 (原有功能)。
  - **交互流程 (新增图片识别)**:
    1.  用户点击 "上传图片识别主体" 按钮，打开本地文件选择器。
    2.  用户选择并上传一张图片（前端限制格式为 JPG/PNG，大小 < 5MB）。
    3.  前端将图片上传至后端新的 API 路由 (`/api/recognize-image`)。
    4.  后端调用**图像识别 AI 服务**，获取对图片的文字描述。
    5.  后端将识别出的文字描述返回给前端。
    6.  前端将返回的描述自动填充到“主体描述”输入框中，用户可在此基础上进行修改。
    7.  在识别过程中，按钮和输入框区域应显示加载状态。
  - **占位符/提示**: `例如：简单背景，穿着黑色短袖的男人 (或上传图片试试)`
  - **文案指引**: _“您可以手动输入详细描述，或上传一张参考图，让 AI 帮您生成描述。”_

- **16 个关键词描述 (Keywords)** (同 V2.0)
  - ... (功能和 UI 保持不变)

##### 2.1.2 操作与反馈

- **生成按钮**: "生成预览图" (文案变更)
  - **交互**: 点击后，后端生成带**水印**的预览图。流程与 V2.0 一致。

#### 2.2 AI 模型调用 (后端逻辑) (更新)

- **API 路由 (`/api/generate-stickers`)** (同 V2.0，但始终生成带水印的图片)
- **新增 API 路由 (`/api/recognize-image`)**:
  - **功能**: 接收前端上传的图片文件。
  - **安全**: 处理文件上传时需注意安全防护，如文件类型、大小校验。
  - **集成**: 调用图生文 AI 服务的 SDK 或 API，将图片数据发送给 AI。
  - **响应**: 将 AI 返回的描述性文本以 JSON 格式返回给前端。
  - **错误处理**: 捕获 AI 调用失败或图片格式错误等异常，并返回友好提示。

#### 2.3 图片处理与预览 (前端逻辑) (更新)

- **预览区**:
  - 生成成功后，网格中展示 16 张**带有明显水印**的 `240x240px` 效果图。水印可以是半透明的 Logo 或 "预览" 字样，覆盖在图片中央，目的是防止用户直接截图使用。

---

### 3. 付费与下载流程 (新增模块)

#### 3.1 付费触发

- **UI 组件**: 在 16 张带水印的预览图下方，原“下载按钮”的位置，替换为一组新的操作按钮：
  1.  **价格展示**: 清晰地展示价格，例如 "￥ 9.9 解锁高清无水印原图"。
  2.  **免费下载水印版**: 点击后可直接打包下载 16 张带水印图片（ZIP）。
  3.  **支付解锁无水印**: 点击后进入支付流程，支付完成后下载无水印版本。
- **交互**:
  1.  用户可随时点击“免费下载水印版”，前端直接打包当前预览图（带水印）为 ZIP 并下载，或调用后端 `GET /api/download-watermarked` 返回 ZIP 文件流。
  2.  用户对预览效果满意后，点击“支付解锁无水印”，弹出支付模态框 (Modal)，展示由 z-pay 生成的支付二维码/跳转链接。

#### 3.2 后端支付逻辑

- **API 路由 (`/api/create-payment-order`)**:
  - **功能**: 前端点击支付按钮时调用此接口。
  - **逻辑**:
    1.  生成一个唯一的内部订单号，并与当前用户的生成任务（或 session/user ID）关联。
    2.  调用 z-pay 创建订单接口，生成支付订单并获取支付凭证（如支付二维码 URL、支付跳转链接）。
    3.  将支付凭证和内部订单号返回给前端。
- **API 路由 (`/api/check-payment-status`)**:
  - **功能**: 前端在用户支付界面轮询调用此接口，以检查支付状态。
  - **逻辑**:
    1.  接收前端传来的内部订单号。
    2.  向 z-pay 查询该订单的支付状态。
    3.  返回支付状态（如 `PENDING`, `SUCCESS`, `FAILED`）。
- **Webhook**:
  - 配置 z-pay 的回调通知 (Webhook/Notify URL)，当支付成功时，z-pay 会主动通知我们的后端。后端接收到通知后，将订单状态在数据库中标记为“已支付”。
  - 参考文档: https://z-pay.cn/doc.html（以实际商户参数与签名校验为准）。

#### 3.3 下载流程

- **A. 免费下载水印版**

  1. 用户点击“免费下载水印版”。
  2. 前端对当前 16 张带水印预览图执行 `JSZip` 打包并下载；或请求后端 `GET /api/download-watermarked` 返回已打包 ZIP（不做鉴权）。
  3. ZIP 内容应仅包含带水印图片（及可选说明文件），不得包含无水印原图数据。

- **B. 支付后下载无水印版**
  1. **支付成功**: 前端通过轮询或 WebSocket 监听到 `SUCCESS` 状态后：
     - 自动关闭支付模态框。
     - 显示提示："支付成功！正在为您打包文件..."。
  2. **触发下载**:
     - 前端向后端 `GET /api/get-download-data` 发起请求，并携带已支付的订单号或凭证。
     - **方案 A (前端打包)**: 后端验证订单有效后，返回**无水印**的 16 张图片 URL 或 Base64。前端按 V2.0 的**无水印版本**处理并 `JSZip` 打包下载。
     - **方案 B (后端打包，推荐)**: 后端验证订单后直接生成无水印（含必要文字/尺寸）的 ZIP，并以文件流返回给前端下载，更安全。
  3. **重复下载**: （可选）绑定账户后，已支付订单在有效期内可重复下载。

---

### 4. 非功能性需求

- 性能:

  - 前端图片处理过程应尽量优化，避免浏览器卡顿。可使用 Web Worker 将密集计算任务移至后台线程。
  - 页面首次加载速度要快，静态资源（如灵感库 JSON）应合理加载。

- 可用性:

  - 界面设计简洁直观，所有交互元素都有明确的视觉反馈。
  - 需适配主流桌面浏览器（Chrome, Firefox, Safari）。

- 可维护性:

  - 代码结构清晰，组件化程度高。
  - 关键配置（如 Prompt 模板、水印内容）应易于修改。

### 5. 验收标准 (更新)

- **图片识别**: 用户可以成功上传图片，并在输入框内看到 AI 生成的文字描述。
- **预览带水印**: 点击生成后，预览区展示的所有 16 张图片都带有清晰的水印。
- **免费水印下载**: 未支付状态下，用户可直接下载带水印 ZIP，ZIP 中不得出现无水印资源。
- **支付流程（z-pay）**: 使用 z-pay 成功下单、查询状态、完成回调并正确更新订单。
- **支付校验**: 未支付用户无法下载无水印 ZIP 或获取无水印原图数据。
- **下载内容**: 支付成功后，下载的 ZIP 必须为无水印版本，且文件结构、尺寸、命名完全符合 V2.0 文档规范。
- **健壮性**: 支付失败或取消支付后，系统状态正确，用户可以重新发起支付。
